#!/bin/bash

# Farben definieren
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Funktion f√ºr animierte Ausgabe
print_animated() {
    text="$1"
    color="$2"
    for (( i=0; i<${#text}; i++ )); do
        echo -n "${color}${text:$i:1}${NC}"
        sleep 0.01
    done
    echo
}

# Funktion f√ºr Fortschrittsbalken
show_progress() {
    local duration=$1
    local steps=50
    local sleep_time=$(echo "scale=4; $duration / $steps" | bc)
    
    echo -ne "${CYAN}["
    for i in $(seq 1 $steps); do
        echo -ne "="
        sleep $sleep_time
    done
    echo -e "]${NC} ${GREEN}‚úì${NC}"
}

# Clear screen
clear

# ASCII Art Header
echo -e "${MAGENTA}"
cat << "EOF"
  _____ _               _                      _       
 / ____| |             | |                    | |      
| |    | |__   ___  ___| | ___ __ ___   __ _| |_ ___ 
| |    | '_ \ / _ \/ __| |/ / '_ ` _ \ / _` | __/ _ \
| |____| | | |  __/ (__|   <| | | | | | (_| | ||  __/
 \_____|_| |_|\___|\___|_|\_\_| |_| |_|\__,_|\__\___|
                                                       
        ____             _             
       |  _ \  ___   ___| | _____ _ __ 
       | | | |/ _ \ / __| |/ / _ \ '__|
       | |_| | (_) | (__|   <  __/ |   
       |____/ \___/ \___|_|\_\___|_|   
                                        
           ____       _               
          / ___|  ___| |_ _   _ _ __  
          \___ \ / __| __| | | | '_ \ 
           ___) | (__| |_| |_| | |_) |
          |____/ \___|\__|\__,_| .__/ 
                               |_|     
EOF
echo -e "${NC}"

echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${CYAN}‚ïë${WHITE}     Checkmate Docker Setup mit Let's Encrypt         ${CYAN}‚ïë${NC}"
echo -e "${CYAN}‚ïë${YELLOW}                 Andreas H√∂fler                        ${CYAN}‚ïë${NC}"
echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

sleep 1

# Willkommensnachricht
print_animated "Willkommen! üëã" "$GREEN"
echo ""
print_animated "Dieses Script hilft dir bei der Einrichtung von Checkmate mit SSL." "$WHITE"
echo ""
sleep 1

# Funktion zur Docker Installation
install_docker() {
    echo ""
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${WHITE}üîß Docker Installation${NC}"
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    
    # Betriebssystem erkennen
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        VERSION=$VERSION_ID
    else
        echo -e "${RED}Kann Betriebssystem nicht erkennen!${NC}"
        return 1
    fi
    
    echo -e "${BLUE}Erkanntes System: $OS $VERSION${NC}"
    echo ""
    
    case $OS in
        ubuntu|debian)
            echo -e "${CYAN}Installiere Docker f√ºr Ubuntu/Debian...${NC}"
            echo ""
            
            # Alte Versionen entfernen
            echo -ne "${CYAN}[1/6] Entferne alte Docker Versionen...${NC} "
            sudo apt-get remove -y docker docker-engine docker.io containerd runc &>/dev/null
            echo -e "${GREEN}‚úì${NC}"
            
            # System aktualisieren
            echo -ne "${CYAN}[2/6] Aktualisiere Paketlisten...${NC} "
            sudo apt-get update -qq &>/dev/null
            echo -e "${GREEN}‚úì${NC}"
            
            # Abh√§ngigkeiten installieren
            echo -ne "${CYAN}[3/6] Installiere Abh√§ngigkeiten...${NC} "
            sudo apt-get install -y -qq \
                ca-certificates \
                curl \
                gnupg \
                lsb-release &>/dev/null
            echo -e "${GREEN}‚úì${NC}"
            
            # Docker GPG Key hinzuf√ºgen
            echo -ne "${CYAN}[4/6] F√ºge Docker GPG Key hinzu...${NC} "
            sudo install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/$OS/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg &>/dev/null
            sudo chmod a+r /etc/apt/keyrings/docker.gpg
            echo -e "${GREEN}‚úì${NC}"
            
            # Docker Repository hinzuf√ºgen
            echo -ne "${CYAN}[5/6] F√ºge Docker Repository hinzu...${NC} "
            echo \
                "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/$OS \
                $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update -qq &>/dev/null
            echo -e "${GREEN}‚úì${NC}"
            
            # Docker installieren
            echo -e "${CYAN}[6/6] Installiere Docker Engine...${NC}"
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            ;;
            
        centos|rhel|fedora)
            echo -e "${CYAN}Installiere Docker f√ºr CentOS/RHEL/Fedora...${NC}"
            echo ""
            
            # Alte Versionen entfernen
            echo -ne "${CYAN}[1/5] Entferne alte Docker Versionen...${NC} "
            sudo yum remove -y docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine &>/dev/null
            echo -e "${GREEN}‚úì${NC}"
            
            # Abh√§ngigkeiten installieren
            echo -ne "${CYAN}[2/5] Installiere Abh√§ngigkeiten...${NC} "
            sudo yum install -y yum-utils &>/dev/null
            echo -e "${GREEN}‚úì${NC}"
            
            # Docker Repository hinzuf√ºgen
            echo -ne "${CYAN}[3/5] F√ºge Docker Repository hinzu...${NC} "
            sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo &>/dev/null
            echo -e "${GREEN}‚úì${NC}"
            
            # Docker installieren
            echo -e "${CYAN}[4/5] Installiere Docker Engine...${NC}"
            sudo yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            
            # Docker starten
            echo -ne "${CYAN}[5/5] Starte Docker...${NC} "
            sudo systemctl start docker
            sudo systemctl enable docker &>/dev/null
            echo -e "${GREEN}‚úì${NC}"
            ;;
            
        *)
            echo -e "${RED}Nicht unterst√ºtztes Betriebssystem: $OS${NC}"
            echo -e "${YELLOW}Bitte installiere Docker manuell: https://docs.docker.com/get-docker/${NC}"
            return 1
            ;;
    esac
    
    # Benutzer zur Docker Gruppe hinzuf√ºgen
    echo ""
    echo -ne "${CYAN}F√ºge Benutzer zur Docker Gruppe hinzu...${NC} "
    sudo usermod -aG docker $USER &>/dev/null
    echo -e "${GREEN}‚úì${NC}"
    
    echo ""
    echo -e "${GREEN}‚úì Docker erfolgreich installiert!${NC}"
    echo -e "${YELLOW}‚ö† Hinweis: M√∂glicherweise musst du dich neu anmelden, damit die Gruppen√§nderungen wirksam werden.${NC}"
    echo ""
    
    return 0
}

# Voraussetzungen pr√ºfen
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${WHITE}üìã Schritt 1: Voraussetzungen pr√ºfen${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Docker Check
echo -ne "${CYAN}Pr√ºfe Docker Installation...${NC} "
if command -v docker &> /dev/null; then
    echo -e "${GREEN}‚úì Installiert${NC}"
    DOCKER_VERSION=$(docker --version | cut -d ' ' -f3 | cut -d ',' -f1)
    echo -e "  ${BLUE}‚Üí Version: $DOCKER_VERSION${NC}"
else
    echo -e "${YELLOW}‚úó Nicht gefunden${NC}"
    echo ""
    echo -e "${CYAN}Soll Docker automatisch installiert werden? (j/n):${NC}"
    read -p "Auswahl: " INSTALL_DOCKER
    
    if [[ "$INSTALL_DOCKER" =~ ^[jJ]$ ]]; then
        if install_docker; then
            echo -e "${GREEN}Docker wurde erfolgreich installiert!${NC}"
        else
            echo -e "${RED}Docker Installation fehlgeschlagen!${NC}"
            exit 1
        fi
    else
        echo -e "${YELLOW}Bitte installiere Docker manuell: https://docs.docker.com/get-docker/${NC}"
        exit 1
    fi
fi

# Docker Compose Check
echo -ne "${CYAN}Pr√ºfe Docker Compose...${NC} "
if command -v docker-compose &> /dev/null || docker compose version &> /dev/null 2>&1; then
    echo -e "${GREEN}‚úì Installiert${NC}"
else
    echo -e "${YELLOW}‚úó Nicht gefunden${NC}"
    echo ""
    echo -e "${CYAN}Installiere Docker Compose Plugin...${NC}"
    
    # Pr√ºfe ob Docker Compose Plugin bereits mit Docker installiert wurde
    if docker compose version &> /dev/null 2>&1; then
        echo -e "${GREEN}‚úì Docker Compose Plugin bereits vorhanden${NC}"
    else
        # Legacy docker-compose installieren
        echo -ne "${CYAN}Installiere docker-compose...${NC} "
        COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
        sudo curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose &>/dev/null
        sudo chmod +x /usr/local/bin/docker-compose
        echo -e "${GREEN}‚úì${NC}"
    fi
fi

# Docker Daemon Status pr√ºfen
echo -ne "${CYAN}Pr√ºfe Docker Daemon Status...${NC} "
if sudo systemctl is-active --quiet docker 2>/dev/null || pgrep dockerd > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì L√§uft${NC}"
else
    echo -e "${YELLOW}‚úó Nicht aktiv${NC}"
    echo -ne "${CYAN}Starte Docker Daemon...${NC} "
    sudo systemctl start docker 2>/dev/null || sudo service docker start 2>/dev/null
    sleep 2
    if sudo systemctl is-active --quiet docker 2>/dev/null || pgrep dockerd > /dev/null 2>&1; then
        echo -e "${GREEN}‚úì${NC}"
    else
        echo -e "${RED}‚úó Fehler${NC}"
        echo -e "${YELLOW}Bitte starte Docker manuell: sudo systemctl start docker${NC}"
    fi
fi

echo ""
sleep 1

# Konfiguration sammeln
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${WHITE}‚öôÔ∏è  Schritt 2: Konfiguration${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Domain abfragen
while true; do
    echo -e "${CYAN}Gib deine Domain ein (z.B. checkmate.example.com):${NC}"
    read -p "Domain: " DOMAIN
    if [[ -z "$DOMAIN" ]]; then
        echo -e "${RED}Domain darf nicht leer sein!${NC}"
    else
        echo -e "${GREEN}‚úì Domain gesetzt: $DOMAIN${NC}"
        break
    fi
done
echo ""

# E-Mail abfragen
while true; do
    echo -e "${CYAN}Gib deine E-Mail-Adresse f√ºr Let's Encrypt ein:${NC}"
    read -p "E-Mail: " EMAIL
    if [[ -z "$EMAIL" ]] || [[ ! "$EMAIL" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
        echo -e "${RED}Bitte gib eine g√ºltige E-Mail-Adresse ein!${NC}"
    else
        echo -e "${GREEN}‚úì E-Mail gesetzt: $EMAIL${NC}"
        break
    fi
done
echo ""

# Secret Key generieren
SECRET_KEY=$(openssl rand -hex 32)
echo -e "${GREEN}‚úì Secret Key generiert${NC}"
echo ""

sleep 1

# Zusammenfassung
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${WHITE}üìù Schritt 3: Zusammenfassung${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""
echo -e "${BLUE}Domain:${NC}           $DOMAIN"
echo -e "${BLUE}E-Mail:${NC}           $EMAIL"
echo -e "${BLUE}Secret Key:${NC}       ${YELLOW}***********${NC}"
echo ""

echo -e "${CYAN}M√∂chtest du mit dieser Konfiguration fortfahren? (j/n):${NC}"
read -p "Auswahl: " CONFIRM

if [[ ! "$CONFIRM" =~ ^[jJ]$ ]]; then
    echo -e "${RED}Setup abgebrochen.${NC}"
    exit 0
fi

echo ""
sleep 1

# Dateien erstellen
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${WHITE}üîß Schritt 4: Dateien erstellen${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

echo -ne "${CYAN}Erstelle docker-compose.yml...${NC} "
cat > docker-compose.yml << EOF
services:
  # Nginx Proxy f√ºr automatisches Reverse Proxying
  nginx-proxy:
    image: nginxproxy/nginx-proxy:latest
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - nginx-certs:/etc/nginx/certs
      - nginx-vhost:/etc/nginx/vhost.d
      - nginx-html:/usr/share/nginx/html
    restart: unless-stopped
    networks:
      - proxy

  # Let's Encrypt Companion f√ºr automatische SSL-Zertifikate
  letsencrypt:
    image: nginxproxy/acme-companion:latest
    container_name: letsencrypt
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - nginx-certs:/etc/nginx/certs
      - nginx-vhost:/etc/nginx/vhost.d
      - nginx-html:/usr/share/nginx/html
      - acme-state:/etc/acme.sh
    environment:
      - DEFAULT_EMAIL=${EMAIL}
      - NGINX_PROXY_CONTAINER=nginx-proxy
    restart: unless-stopped
    networks:
      - proxy
    depends_on:
      - nginx-proxy

  # MongoDB Datenbank f√ºr Checkmate
  mongodb:
    image: ghcr.io/bluewave-labs/checkmate-mongo:latest
    container_name: checkmate-db
    restart: unless-stopped
    command: ["mongod", "--quiet", "--bind_ip_all"]
    volumes:
      - ./mongo/data:/data/db
    networks:
      - checkmate-internal
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 5s
      timeout: 30s
      start_period: 0s
      start_interval: 1s
      retries: 30

  # Checkmate Server
  server:
    image: ghcr.io/bluewave-labs/checkmate-backend-mono:latest
    container_name: checkmate
    pull_policy: always
    restart: unless-stopped
    environment:
      - UPTIME_APP_API_BASE_URL=https://${DOMAIN}/api/v1
      - UPTIME_APP_CLIENT_HOST=https://${DOMAIN}
      - DB_CONNECTION_STRING=mongodb://mongodb:27017/uptime_db
      - CLIENT_HOST=https://${DOMAIN}
      - JWT_SECRET=${SECRET_KEY}
      - VIRTUAL_HOST=${DOMAIN}
      - VIRTUAL_PORT=52345
      - LETSENCRYPT_HOST=${DOMAIN}
      - LETSENCRYPT_EMAIL=${EMAIL}
    networks:
      - proxy
      - checkmate-internal
    depends_on:
      mongodb:
        condition: service_healthy

networks:
  proxy:
    driver: bridge
  checkmate-internal:
    driver: bridge

volumes:
  nginx-certs:
  nginx-vhost:
  nginx-html:
  acme-state:
EOF
echo -e "${GREEN}‚úì${NC}"

echo -ne "${CYAN}Erstelle .env Datei...${NC} "
cat > .env << EOF
# Domain Konfiguration
DOMAIN=${DOMAIN}
EMAIL=${EMAIL}

# Checkmate Konfiguration
SECRET_KEY=${SECRET_KEY}

# Erstellt von: Andreas H√∂fler Setup Script
# Datum: $(date '+%Y-%m-%d %H:%M:%S')
EOF
echo -e "${GREEN}‚úì${NC}"

echo -ne "${CYAN}Erstelle .gitignore...${NC} "
cat > .gitignore << EOF
.env
*.log
*.swp
*~
EOF
echo -e "${GREEN}‚úì${NC}"

echo ""
sleep 1

# DNS Check
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${WHITE}üåê Schritt 5: DNS √úberpr√ºfung${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

echo -ne "${CYAN}Pr√ºfe DNS Aufl√∂sung f√ºr $DOMAIN...${NC} "

# Zuerst pr√ºfen ob Domain in /etc/hosts ist und automatisch bereinigen
if grep -q "$DOMAIN" /etc/hosts 2>/dev/null; then
    echo -e "${YELLOW}‚ö†${NC}"
    echo -e "  ${YELLOW}‚Üí Domain gefunden in /etc/hosts!${NC}"
    echo -e "  ${CYAN}‚Üí Entferne lokalen Eintrag...${NC} "
    
    # Backup erstellen
    sudo cp /etc/hosts /etc/hosts.backup.$(date +%Y%m%d_%H%M%S)
    
    # Zeilen mit der Domain entfernen
    sudo sed -i "/$DOMAIN/d" /etc/hosts
    
    echo -e "  ${GREEN}‚úì Lokaler Eintrag entfernt${NC}"
    echo -e "  ${BLUE}‚Üí Backup erstellt: /etc/hosts.backup.*${NC}"
    echo ""
    echo -ne "${CYAN}Pr√ºfe DNS Aufl√∂sung erneut...${NC} "
fi

# DNS Aufl√∂sung pr√ºfen - verschiedene Tools probieren
DNS_LOOKUP=""
if command -v host &> /dev/null; then
    DNS_LOOKUP=$(host "$DOMAIN" 2>/dev/null)
elif command -v nslookup &> /dev/null; then
    DNS_LOOKUP=$(nslookup "$DOMAIN" 2>/dev/null | grep -A1 "Name:" | grep "Address:")
elif command -v dig &> /dev/null; then
    DNS_LOOKUP=$(dig +short "$DOMAIN" 2>/dev/null)
else
    echo -e "${YELLOW}‚ö† Kein DNS-Tool gefunden${NC}"
    echo -e "  ${YELLOW}‚Üí Installiere 'bind-utils' oder 'dnsutils' f√ºr DNS-Checks${NC}"
    echo ""
    sleep 1
fi

if [[ -n "$DNS_LOOKUP" ]]; then
    # IPs extrahieren je nach verwendetem Tool
    if command -v host &> /dev/null; then
        RESOLVED_IPS=$(echo "$DNS_LOOKUP" | grep "has address" | awk '{print $4}')
    elif command -v nslookup &> /dev/null; then
        RESOLVED_IPS=$(echo "$DNS_LOOKUP" | grep "Address:" | awk '{print $2}')
    else
        RESOLVED_IPS="$DNS_LOOKUP"
    fi
    
    # Loopback-Adressen (127.x.x.x und ::1) herausfiltern
    PUBLIC_IPS=$(echo "$RESOLVED_IPS" | grep -v "^127\." | grep -v "^::1" | grep -v "^$")
    
    if [[ -z "$PUBLIC_IPS" ]]; then
        echo -e "${RED}‚úó${NC}"
        echo -e "  ${RED}‚Üí Domain zeigt nur auf lokale IP (127.x.x.x)${NC}"
        echo -e "  ${YELLOW}‚Üí Dies ist ein Fehler in deiner /etc/hosts oder DNS-Konfiguration${NC}"
        echo -e "  ${YELLOW}‚Üí Let's Encrypt wird definitiv fehlschlagen!${NC}"
        echo -e "  ${YELLOW}‚Üí Bitte konfiguriere einen √∂ffentlichen A-Record f√ºr $DOMAIN${NC}"
        echo ""
        echo -e "  ${CYAN}Tipps zur Fehlerbehebung:${NC}"
        echo -e "  ${WHITE}1. Pr√ºfe /etc/hosts: ${CYAN}cat /etc/hosts | grep $DOMAIN${NC}"
        echo -e "  ${WHITE}2. Teste externe DNS: ${CYAN}nslookup $DOMAIN 8.8.8.8${NC}"
        echo -e "  ${WHITE}3. Leere DNS-Cache: ${CYAN}sudo systemd-resolve --flush-caches${NC}"
    else
        RESOLVED_IP=$(echo "$PUBLIC_IPS" | head -n1)
        echo -e "${GREEN}‚úì${NC}"
        echo -e "  ${BLUE}‚Üí Aufgel√∂st zu: $RESOLVED_IP${NC}"
        
        # Mehrere IPs? Zeige alle an
        IP_COUNT=$(echo "$PUBLIC_IPS" | wc -l)
        if [[ $IP_COUNT -gt 1 ]]; then
            echo -e "  ${BLUE}‚Üí Weitere IPs gefunden:${NC}"
            echo "$PUBLIC_IPS" | tail -n +2 | while read ip; do
                echo -e "    ${BLUE}‚Ä¢ $ip${NC}"
            done
        fi
        
        # Server IP ermitteln
        echo -ne "  ${CYAN}‚Üí Ermittle Server IP...${NC} "
        SERVER_IP=$(curl -s --max-time 5 ifconfig.me 2>/dev/null || curl -s --max-time 5 icanhazip.com 2>/dev/null || curl -s --max-time 5 api.ipify.org 2>/dev/null)
        
        if [[ -n "$SERVER_IP" && "$SERVER_IP" != "unbekannt" ]]; then
            echo -e "${GREEN}$SERVER_IP${NC}"
            
            # Pr√ºfe ob eine der aufgel√∂sten IPs mit der Server-IP √ºbereinstimmt
            if echo "$PUBLIC_IPS" | grep -q "^${SERVER_IP}$"; then
                echo -e "  ${GREEN}‚úì DNS korrekt konfiguriert!${NC}"
            else
                echo -e "  ${YELLOW}‚ö† Warnung: DNS zeigt auf andere IP!${NC}"
                echo -e "  ${YELLOW}  Domain IP: $RESOLVED_IP${NC}"
                echo -e "  ${YELLOW}  Server IP: $SERVER_IP${NC}"
                echo -e "  ${YELLOW}  Let's Encrypt k√∂nnte fehlschlagen.${NC}"
                echo ""
                echo -e "  ${CYAN}M√∂gliche Ursachen:${NC}"
                echo -e "  ${WHITE}1. DNS-√Ñnderungen noch nicht propagiert (kann 24-48h dauern)${NC}"
                echo -e "  ${WHITE}2. Domain zeigt auf falschen Server${NC}"
                echo -e "  ${WHITE}3. Server hat mehrere IP-Adressen${NC}"
                echo -e "  ${WHITE}4. Du verwendest einen Proxy/CDN (z.B. Cloudflare)${NC}"
            fi
        else
            echo -e "${YELLOW}Fehler${NC}"
            echo -e "  ${YELLOW}‚Üí Konnte Server-IP nicht ermitteln${NC}"
            echo -e "  ${YELLOW}‚Üí Bitte pr√ºfe manuell, ob $RESOLVED_IP zu diesem Server geh√∂rt${NC}"
        fi
    fi
else
    echo -e "${RED}‚úó${NC}"
    echo -e "  ${RED}‚Üí Domain konnte nicht aufgel√∂st werden${NC}"
    echo -e "  ${YELLOW}‚Üí Stelle sicher, dass ein A-Record f√ºr $DOMAIN existiert!${NC}"
    if command -v nslookup &> /dev/null; then
        echo -e "  ${YELLOW}‚Üí Pr√ºfe mit: ${CYAN}nslookup $DOMAIN${NC}"
    else
        echo -e "  ${YELLOW}‚Üí Installiere DNS-Tools: ${CYAN}apt install dnsutils${NC} oder ${CYAN}yum install bind-utils${NC}"
    fi
fi

echo ""
sleep 1

# Abschlussfrage
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${WHITE}üöÄ Schritt 6: Container starten${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

echo -e "${CYAN}M√∂chtest du die Container jetzt starten? (j/n):${NC}"
read -p "Auswahl: " START_CONTAINERS

if [[ "$START_CONTAINERS" =~ ^[jJ]$ ]]; then
    echo ""
    echo -ne "${CYAN}Starte Container...${NC} "
    echo ""
    
    # Pr√ºfe ob docker-compose oder docker compose verwendet werden soll
    if command -v docker-compose &> /dev/null; then
        COMPOSE_CMD="docker-compose"
    else
        COMPOSE_CMD="docker compose"
    fi
    
    if $COMPOSE_CMD up -d; then
        echo ""
        echo -e "${GREEN}‚úì Container erfolgreich gestartet!${NC}"
        echo ""
        
        echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${GREEN}üéâ Setup abgeschlossen!${NC}"
        echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo ""
        echo -e "${WHITE}Deine Checkmate-Instanz wird unter folgender URL erreichbar sein:${NC}"
        echo -e "${GREEN}‚Üí https://$DOMAIN${NC}"
        echo ""
        echo -e "${YELLOW}Hinweis:${NC}"
        echo -e "  ‚Ä¢ SSL-Zertifikat kann bis zu 5 Minuten dauern"
        echo -e "  ‚Ä¢ Logs anzeigen: ${CYAN}$COMPOSE_CMD logs -f${NC}"
        echo -e "  ‚Ä¢ Status pr√ºfen: ${CYAN}$COMPOSE_CMD ps${NC}"
        echo ""
        echo -e "${MAGENTA}Viel Erfolg, Andreas! üöÄ${NC}"
        echo ""
    else
        echo ""
        echo -e "${RED}‚úó Fehler beim Starten der Container${NC}"
        echo -e "${YELLOW}Pr√ºfe die Logs mit: $COMPOSE_CMD logs${NC}"
    fi
else
    echo ""
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${GREEN}‚úì Konfiguration gespeichert!${NC}"
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${WHITE}Starte die Container sp√§ter mit:${NC}"
    
    # Zeige den richtigen Befehl an
    if command -v docker-compose &> /dev/null; then
        echo -e "${CYAN}‚Üí docker-compose up -d${NC}"
    else
        echo -e "${CYAN}‚Üí docker compose up -d${NC}"
    fi
    echo ""
    echo -e "${MAGENTA}Bis bald, Andreas! üëã${NC}"
    echo ""
fi
